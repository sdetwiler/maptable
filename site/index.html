<html>
<head>
    <title>Map Table</title>
    <link rel="stylesheet" href="assets/css/style.css"/>

    <link rel="stylesheet" href="assets/leaflet/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <script src="assets/leaflet/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
</head>

<div id="content">
    <div id="map"></div>
    <div id="controls">
        <div class="controlsFooter">Map Table v1.0.0</div>
    </div>
</div>



<script>
    var manifest = null;

    var map = L.map('map').setView([37.804334, -122.271155], 13);
    map.setMinZoom(13)
    map.setMaxZoom(16)

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      }).addTo(map);

    var layers = {}
    function addLayer(idx)
    {
        var layer = null;
        if(idx in layers)
        {
            layer = layers[idx];
        }
        else
        {
            var m = manifest["maps"][idx];
            layer = L.tileLayer(m["path"] + "/{z}/{x}/{y}.png", {
                attribution: m["attribution"]
            });
            layers[idx] = layer;
        }
        layer.addTo(map);
    }

    function removeLayer(idx)
    {
        if(idx in layers)
        {
            layer = layers[idx];
            layer.removeFrom(map);
        }
    }

    function addRemoveLayer(idx)
    {
        console.log(event.target);
        var enabled = event.target.getAttribute("enabled");
        if(enabled == "0")
        {
            addLayer(idx)
            event.target.setAttribute("enabled", "1");
            event.target.setAttribute("class", "mapItemEnabled");
        }
        else
        {
            removeLayer(idx);
            event.target.setAttribute("enabled", "0");
            event.target.setAttribute("class", "mapItem");
        }
    }

    function addMapItemByIndex(idx)
    {
        var m = manifest["maps"][idx];
        console.log(m);
        var controls = document.getElementById("controls");
        var mapItem = document.createElement("div");
        mapItem.setAttribute("enabled", "0");
        mapItem.setAttribute("class", "mapItem");
        mapItem.setAttribute("onclick", "addRemoveLayer(" +idx + ")");
        mapItem.innerText = m["name"];
        controls.appendChild(mapItem);
    }

    function loadManifest()
    {
        var req = new XMLHttpRequest();
        req.overrideMimeType("application/json");
        req.open("GET", "assets/tiles/manifest.json", true);
        req.onload  = function() {
            manifest = JSON.parse(req.responseText);
            for(i=0; i<manifest["maps"].length; ++i)
            {
                addMapItemByIndex(i);
            }
        };
        req.send(null);        
    }

    function init()
    {
        console.log("init");
        loadManifest();
    }

    document.addEventListener("DOMContentLoaded", init);

</script>
    
</html>